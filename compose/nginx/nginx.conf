worker_processes  auto;
error_log  logs/error.log;
pid        logs/nginx.pid;


events {
    worker_connections  65535;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
    server_tokens off;
    autoindex off;
    port_in_redirect off;
    client_body_timeout 10;
    client_header_timeout 10;
    keepalive_timeout 5 65;
    send_timeout 10;
    proxy_hide_header x-powered-By ;
    limit_req_zone $binary_remote_addr zone=one:100k rate=20r/s ;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';
    access_log logs/access.log main;

    sendfile        on;
    map $http_x_real_client_addr $clientRealIp {
        "" $remote_addr;
        ~^(?P<firstAddr>[0-9.]+).$ $firstAddr;
        default $http_x_real_client_addr;
    }
    gzip  on;# nginx开启静态资源压缩,比如nginx返回磁盘的html文件特别大,里面包含了诸多的静态文件,极大提升网站访问

    upstream gunicorn_app {
        hash $clientRealip;
        server 192.168.190.2:39979;
    }


    server {
        listen       443  ssl;
        server_name  192.168.190.2;
        ssl_certificate /usr/share/nginx/ssl/recruitment.crt;
        ssl_certificate_key /usr/share/nginx/ssl/recruitment.key;
        ssl_ciphers "ECDHE-RSA-AES-256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256" ;   # 使用安全密码套件
        ssl_prefer_server_ciphers on ;   # 协商时优先使用服务器指定的加密算法
        ssl_session_cache shared:SSL:1m; # 每1M缓存可以存储4000个会话,有效提升https网站处理ssl并发的能力
        ssl_session_timeout 5m; # 设置合适的超时时间
        ssl_protocols TLSv1.2 TLSv1.3 ; #nginx1.13.0版本开始支持TLSv1.3,#如果不配置ssl_protocols,默认使用TLSV1，TLSV1.1,TLSV1.2根据,安全要求TLS协议,ngin需要openssl版本>=1.01来支持TLSv1.2


        charset utf-8; #网站编码

        # 响应头配置
        add_header X-XSS-Protection "1; mode=block";    #提供xss防护功能,必须设置
        add_header Content-Security-Policy "default-src 'self' data: *.xxx.com  'unsafe-inline' 'unsafe-eval' mediastream: ";
        add_header X-Content-Type-Options "nosniff";#提供禁用浏览器的类型猜测功能,必须设置
        add_header X-Frame-Options SAMEORIGIN; #提供点击劫持防护功能必须设定
        add_header Strict-Transport-Security "max-age=63072000; includeSubdomains; preload";# 提供请求强制走https协议功能,必须设置
        add_header Pragma no-cache; #页面缓存控制响应头
        add_header Expire 0;
        add_header Cache-Control "no-cache,no-store,must-revalidate";
        add_header Referrer-Policy "no-referner";
        # 当一个源站点将用户定向到另一个站点时，将发送一个确定用户来源的url的推荐人，根据您网站的具体用途，就可能会给您的用户带来隐私问题。Referring策略允许组织定义哪些站点应该看到来自您站点的推荐，这有助于保护用户隐私。如果在url参数如个人信息，用户名和密码或持久会话中使用敏感数据,则refer标头可能会在另一个为服务器的日志中公开平台数据，最终根据您的应用程序设计,不使用正确配置的refer策略可能会导致会话劫持凭据收集或者第三方日语中的敏感数据泄露。
        add_header X-Download-Options noopen;
        add_header X-Permitted-Cross-Domain-Policies none;
        # 请求头和请求体设置
        large_client_header_buffers 4 8k; # 参数含义是申请4个8K的请求头缓冲区
        client_header_buffer_size 1k; # nginx默认会用client_header_buffer_size来读取header
        client_body_buffer_size 16k;  # 缓冲客户端请求的最大字节
        client_max_body_size 5m; #客户端请求的最大单文件字节数
        #备注:没有以上所定义的缓冲就是大小是建议值,在报告请求过程中,报request url too large (414)或者bad request(400)错误,则需增加缓冲区大小,产品如果有特殊要求,可以根据自身的需求进行.相应的调整

        # 代理设置
        proxy_connect_timeout 180;
        proxy_read_timeout 180;
        proxy_send_timeout 180;

        location /static {
            add_header X-XSS-Protection "1; mode=block";    #提供xss防护功能,必须设置
            add_header Content-Security-Policy "default-src 'self'"; # 提供对加载资源的安全控制功能
            add_header X-Content-Type-Options "nosniff";#提供禁用浏览器的类型猜测功能,必须设置
            add_header X-Frame-Options SAMEORIGIN; #提供点击劫持防护功能必须设定
            add_header Pragma no-cache; #页面缓存控制响应头
            add_header Expire 0;
            add_header Cache-Control "no-cache,no-store,must-revalidate";
            add_header Strict-Transport-Security "max-age=31536000; includeSubdomains";# 提供请求强制走https协议功能,必须设置
            alias /home/jason/recruitment/src/static;
        }

        location / {
            # 代理设置
            proxy_pass   http://gunicorn_app;
            proxy_set_header Host $host;
            #X-forward-for和 remote address标头有助于识别和分离用户代理的原始客户端IP地址和代理IP地址,这两种类型地址是相同的,其中一种应该始终存在。将客户端的真实IP地址作为x-real-ip的值传递给后端服务器，以便后端服务器可以获取客户端的真实ip地址。The panda x rio IP dollar remote。Address
            proxy_set_header X-Real-IP $remote_addr;
            #将客户端的真实IP地址添加到x-forward-for头部中,以便后端服务器可以获取客户端的IP地址和代理服务器的IP地址。
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            #将客户端的真实IP作为X-Gunicorn-IP的值传递给后端服务器,以便后端服务器可以获取客户端的真实IP地址。这个指令是针对使用Gunicorn作为应用服务器的情况下的设置
            proxy_set_header X-Gunicorn-IP $http_x_real_client_addr;

            #real_ip_recursive,这是一个nginx配置命令,用于指定是否递归地将X-Forwarded-For投中所有IP地址替换为客户端的真实IP地址。如果设置为on, nginx将递归递查找 X-Forwarded-For头中所有的IP地址,并将最后一个IP地址替换为客户端的真实IP地址。
            #real_ip_recursive on;

            limit_except GET POST HEAD {
                 deny  all;# HTTP请求方法在全目录'/'目录下除了get post head返回403
            }
        }

        location ~*\.(gif|png|bmp|jpe?g)$ {
            expires 7d;
            add_header Pragma public;
            add_header Cache-Control "public,must-revalidate,proxy-revalidate";
            valid_referers none blocked server_names ~\.google\. ~\.baidu\.;
            if ($invalid_referer) {
                rewrite ^(.*)$ /static/images/hotlink-denied.jpg redirect;
                                   }
            }

        error_page  404              /404.html;
        location = /40x.html {
            root   html;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

 }
}
